# 全轮 AES-256 唯密文区分（Hybrid Statistical Learning）完整实现指南

- 目标：在唯密文（ciphertext-only）设置下，区分“全轮 AES-256 密文”和“真随机数据”，采用混合统计学习（多模型）进行判别。
- 适用项目路径：`/home/fate/gitproject/aes_recovery`
- 文档用途：给出论文的完整实现流程、配置、运行方法，以及与当前仓库实现的差异与修复清单。

## 项目结论
- 当前仓库并未完整符合论文“全轮 AES-256 唯密文区分”的实现要求：
  - 未生成 AES-256 全轮密文数据；默认数据生成使用的是自定义 `AES128`，且仅支持 128 位密钥（`utils/data_generate_utils.py:83-85`）。
  - 存在 `AES256` 类，但数据生成未调用；默认优先选择数据集键为 `aes128_custom_single`（`main.py:128-137`）。
  - 统计学习为多模型独立训练评估，缺少“混合/融合”策略（如投票、堆叠或加权融合）。
  - 配置说明中写有“4个随机数据集”，但生成流程只写入一个合并集（`generate_and_save_data` 单一 `random_batches`）。

> 结论：需要按下述修复清单调整代码与配置，方可达到论文的“完整实现”。

## 复现环境
- Python 版本：建议 `>=3.9`
- 依赖（见 `requirements.txt`）：
  - `numpy`, `scipy`, `scikit-learn`, `matplotlib`, `pycryptodome`, `pyentrp`, `pandas`, `PyYAML`
- 安装命令：
  ```bash
  pip install -r requirements.txt
  ```

## 数据生成（AES-256 全轮 + 随机集）
- 论文要求：
  - 明文为 128bit 分组（AES 固定块大小 16 字节）。
  - 密钥为 256bit（32 字节），AES-256 全轮实现（14 轮，标准密钥扩展）。
  - 唯密文设置：样本不依赖明文/密钥标签，仅使用密文统计特征。
  - 随机数据：至少 2-4 个独立随机数据集，用于参考与评估。

- 推荐实现方式（与当前仓库兼容）：
  1. 使用 `PyCryptodome` 生成 AES-256 ECB 全轮密文（库实现即为标准全轮）。
  2. 明文：对每个样本生成 `16B` 随机明文；密钥：单密钥与多密钥两种设置均可。
  3. 批次：`BATCH_NUM` 批，每批 `SAMPLE_PER_BATCH` 样本，输出为 128bit 整数。

- 生成接口建议：
  - 在 `utils/data_generate_utils.py` 增加 `generateAes256CiphertextsBatch(key_size=32, is_Multi=True)`，调用 `Crypto.Cipher.AES.new(key, AES.MODE_ECB)`，对 `SAMPLE_PER_BATCH` 个明文加密并返回整数数组。
  - 在 `generate_and_save_data()` 中并行保存：
    - `aes256_single` 与 `aes256_multi` 两类数据集（与现有 `np.savez` 键兼容）。
  - 随机数据集：将 `RANDOM_SET_NUM` 个独立数据集分别保存（避免仅合并为单一集合）。

- 形状与存储：
  - 每批输出 `list[int]`，整型表示 128bit 密文。
  - 汇总为 `np.savez(data/aes_datasets.npz, ...)`，包含键：
    - `random_datasets`: 形如 `[dataset_0_batches, dataset_1_batches, ...]`
    - `aes256_single`, `aes256_multi`（可选：也保留 `aes128_*` 供对比）

## 特征工程（统计测试）
- 当前仓库已实现并扩展了多种统计测试函数（`features/stat_tests.py`）。核心流程：
  - 批次级特征提取：`features/feature_process.py:13-41` 将每批次样本映射为特征向量。
  - 对比批次设定：
    - 参考随机批次与评估批次解耦（`feature_process.py:62-90`），避免数据泄露。
  - 特征筛选：
    - KS 双样本检验保留显著性维度（`feature_process.py:93-135`），无显著性时按统计量 TopK 回退。

- 论文对齐建议：
  - 在 `configs/common.yaml` 中精简 `STAT_TESTS` 至论文列出的 20 项，或保留扩展项但在筛选阶段记录被保留的名称。
  - 保持 `BLOCK_SIZE=16` 与 `ALPHA=0.05`，并使用 `BATCH_NUM` 与 `SAMPLE_PER_BATCH` 保障统计稳定性。

## 模型与训练（Hybrid 学习）
- 当前仓库模型初始化（`models/model_init.py:1-43`）包含：SVM、随机森林、逻辑回归、朴素贝叶斯、MLP。
- 训练与评估（`trainer/train_model.py`）：
  - `train_models`：逐模型拟合（`trainer/train_model.py:14-22`）。
  - `evaluate_models`：输出分类报告（`trainer/train_model.py:25-45`）。
  - `k_fold_cross_validation`：5/10 折交叉验证（`trainer/train_model.py:49-83`）。

- 论文“Hybrid”建议补充：
  - 增加融合策略（任一即可）：
    - 简单投票：各模型二分类投票，取多数结果；
    - 概率平均：取 `predict_proba` 的均值后阈值判定；
    - 堆叠学习：一级模型输出作为二级逻辑回归/线性 SVM 的输入。
  - 在 `evaluate_models` 中同时输出融合模型的评估指标，作为最终结果。

## 可视化
- 已提供 PCA 与 tSNE（`visualization/plots.py`）。
- 使用方法：在筛选后的特征上分别绘制 AES 密文与随机数据的二维嵌入分布。

## 运行流程
1. 配置：编辑 `configs/common.yaml`
   - `BLOCK_SIZE: 16`
   - `AES_ROUNDS: 14`（仅用于位数组实现；如改用 PyCryptodome 生成 AES-256，可忽略该参数）
   - `BATCH_NUM` 与 `SAMPLE_PER_BATCH` 根据资源调整（论文级别建议较大）。
   - `RANDOM_SET_NUM: 4`
2. 生成数据：
   - 增加 AES-256 批次生成接口并在 `generate_and_save_data()` 写入 `aes256_*` 键。
   - 运行：
     ```bash
     python -m utils.data_generate_utils  # 或直接运行 main 首次自动生成
     ```
3. 主流程（按步骤执行或全流程）：
   - 全流程：
     ```bash
     python main.py --steps all --cipher_key aes256_single
     ```
   - 分步（示例）：
     ```bash
     python main.py --step data features filter prepare train cv plot --cipher_key aes256_single
     ```

## 结果与验证
- 指标：精准率、召回率、F1（`evaluate_models`）与交叉验证平均值（`k_fold_cross_validation`）。
- 可视化产物：
  - `plots/pca_features.png`
  - `plots/tsne_features.png`
  -（可选）Top-KDE：`plot_top_kde_features`（`main.py:206-241` 调用链）

## 与当前仓库的差异与修复清单
- 数据生成：
  - 调整 `utils/data_generate_utils.py`：
    - 现状：仅 `AES128` 自定义轮数（`generateAesCiphertextsBatch`）。
    - 修复：新增 `generateAes256CiphertextsBatch`（PyCryptodome 或 `cipher/AES256.py`），并写入 `aes256_single/aes256_multi`。
- 主流程默认数据集：
  - 现状：默认优先 `aes128_custom_single`（`main.py:128-137`）。
  - 修复：若存在 `aes256_single` 优先选之，或通过命令行 `--cipher_key aes256_single` 强制选择。
- 密钥扩展与位数组接口：
  - 现状：`AES128.encrypt` 接受 128/192/256 位密钥，但 `_key_schedule` 固定 `Nk=4`（`cipher/AES128.py:279-311`），不对应 AES-256。
  - 修复：对位数组使用时，改为调用 `AES256._key_schedule`（`cipher/AES256.py:27-69`）或直接改用 PyCryptodome 生成密文。
- 随机数据集数量：
  - 现状：`RANDOM_SET_NUM=4` 仅体现在注释/接口，保存阶段仅一个集合 `random_batches`。
  - 修复：按 `RANDOM_SET_NUM` 分别保存并在 `load_data()` 返回为列表形式，供参考/评估批次解耦。
- 混合学习（Hybrid）：
  - 现状：多模型独立评估，无融合。
  - 修复：新增融合器，并在评估中输出其指标作为最终结论。

## 常见问题
- tSNE 报错或不稳定：仓库已做归一化与裁剪，且自适应 `perplexity`（`visualization/plots.py:72-121`）。
- 特征筛选为空：自动回退为 KS 统计量 TopK（`features/feature_process.py:126-134`）。
- 运行内存压力：数据生成采用分批保存与合并（`utils/data_generate_utils.py:118-203`）。

## 参考
- 论文：Distinguishing Full-Round AES-256 in a Ciphertext-Only Setting via Hybrid Statistical Learning
- 代码引用位置（便于快速定位）：
  - 入口与流程控制：`main.py:1-243`
  - 数据生成与加载：`utils/data_generate_utils.py:118-221`
  - 统计测试集合：`features/stat_tests.py:1-900`
  - 特征提取与筛选：`features/feature_process.py:13-168`
  - 模型初始化：`models/model_init.py:1-43`
  - 训练与评估：`trainer/train_model.py:1-86`
  - 可视化：`visualization/plots.py:1-158`

---

> 说明：本指南给出论文的“完整实现”所需的流程与修复点。按上述清单微调当前仓库即可复现论文设定下的实验与结果展示。
